<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Online White Board</title>
  <style lang="">
    * {
      box-sizing: border-box;
    }
    canvas {
      border: 1px solid black;
    }
    /* 颜色选择器样式 */
    div:first-of-type {
      display: flex;
      align-items: flex-start;
      margin-bottom: 5px;
    }

    input[type="radio"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;

      border: 4px solid #fff;
      transition: 0.2s all linear;
      outline: none;
      margin-right: 5px;

      position: relative;
      top: 4px;
    }

    input:checked {
      border: 4px solid rgba(80, 178, 228, 0.82);
    }

    .black {
      background-color: black;
    }
    .red {
      background-color: red;
    }
    .yellow {
      background-color: yellow;
    }
    textarea {
      border: none;
    }
    textarea:focus {
      outline: none;
    }
  </style>
</head>
<body>
  <p><span>工具栏</span><button id="id-clear" type="button">清空画布</button></p>
  <form name='colorselector'>
    <label for="">选择颜色</label>
    <input type="radio" class="black" name="color" value="black" checked>
    <input type="radio" class="red" name="color" value="red">
    <input type="radio" class="yellow" name="color" value="yellow">
    <input id="id-color-picker" type="color" value="#ff0000">
  </form>
  <form>
    <label>画笔粗细</label>
    <input type="range" min="1" max="10" value="1" name="line-width"></input>
  </form>
  <form>
    <label>文字</label>
    <input type="checkbox" name="text"></input>
  </form>

  <canvas id="id-canvas" width="500" height="500"></canvas>
  <textarea id="id-textarea" autofocus></textarea>
</body>
<script src="./ws-client.js"></script>
<script>
//初始化
  // dom 对象
var sel = el => document.querySelector(el)
var selAll = el => document.querySelectorAll(el)
var log = console.log.bind(console)
var clearBtn = sel('#id-clear')
var canvas = sel('#id-canvas')
var ctx = canvas.getContext('2d')
var colorRadios = selAll('input[name="color"]')
var colorPicker = sel('#id-color-picker')
var lineWidthInput = sel('input[name="line-width"]')
var isTextInput = sel('input[name="text"]')
var textarea = sel('#id-textarea')
// board对象和其方法
var board = {}
board.curColor = Array.prototype.find.call(colorRadios, e => e.checked == true).value
board.curLineWidth = 1
board.canvas = canvas
board.ctx = ctx
board.enableDraw = false
board.isConnected = true
board.isText = false
board.historys = []
board.socket = socket

board.init = function() {
  board.isText = isTextInput.checked
}
board.clear = function() {
  var canvas = board.canvas
  board.ctx.clearRect(0, 0, canvas.width, canvas.height)
}
board.startDraw = function(data) {
  var x = data.x
  var y = data.y
  var ctx = board.ctx
  board.enableDraw = true
  ctx.beginPath()
  ctx.moveTo(x, y)
}
board.draw = function(data) {
  var ctx = board.ctx
  var x = data.x
  var y = data.y
  var strokeStyle = data.strokeStyle
  var lineWidth = data.lineWidth
  if(!board.enableDraw) {
    return false
  }
  ctx.strokeStyle = strokeStyle
  ctx.lineWidth = lineWidth
  ctx.lineTo(x, y)
  ctx.stroke()
  return true
}
board.endDraw = function(data) {
  board.enableDraw = false
}

board.receiveMsg = function(msg) {
  var type = msg.type
  // if(msg.coord == undefined) {
  //   board[type]()
  //   return
  // }
  var data = msg.data
  log(type, data)
  board[type](data)
}
board.sendMsg = function(type, data) {
  if(!board.isConnected) {
    return
  }
  var msg = {
    type: type,
    data: data,
  }
  board.socket.send(JSON.stringify(msg))
}

var drawStartSend = function(event) {
  var data = {
    x: event.layerX,
    y: event.layerY,
  }
  board.startDraw(data)
  board.sendMsg('startDraw', data)
}
var drawSend = function(event) {
  var data = {
    x: event.layerX,
    y: event.layerY,
    strokeStyle: board.curColor,
    lineWidth: board.curLineWidth
  }
  if(board.isText) {
    return    
  }
  if(!board.draw(data)) {
    return
  }
  board.sendMsg('draw', data)
}
var endDrawSend = function(event) {
  board.endDraw()
  board.sendMsg('endDraw')
}
var clearBoard = function(event) {
  board.clear()
}
var setCurColor = function(event) {
  var value = event.target.value
  if(value !== board.curColor) {
    board.curColor = value
    log('curColor: ', board.curColor)
  }
}
var setCurLineWidth = function(event) {
  var value = event.target.value
  if(value !== board.curLineWidth) {
    board.curLineWidth = value
    log('Current Line Width: ', board.curLineWidth)
  }
}
var setIsText = function(event) {
  var isChecked = event.target.checked
  if(isChecked !== board.isText) {
    board.isText = isChecked
    board.canvas.style.cursor = isChecked ? "crosshair" : "default"
  }
}
var changeTextarea = function(event) {
  if(!board.isText) {
    return
  }
  var x = event.clientX
  var y = event.clientY
  var width = board.canvas.offsetLeft + board.canvas.width - x
  var height = board.canvas.offsetTop + board.canvas.height - y
  textarea.style.position = "absolute"
  textarea.style.left = x + "px"
  textarea.style.top = y + "px"
  textarea.style.width = width + "px"
  textarea.style.height = height + "px"
  textarea.canvasX = event.layerX
  textarea.canvasY = event.layerY
  log('x, y', textarea.canvasX, textarea.canvasY)
  textarea.focus()
}
var fillText = function(event) {
  var text = textarea.value
  if(text.length > 0) {
    board.ctx.fillText(text, textarea.canvasX, textarea.canvasY)
    textarea.style.display = "none"
    log('text: ', textarea.canvasX, textarea.canvasY)
  }
} 
board.canvas.addEventListener('mousedown', drawStartSend)
board.canvas.addEventListener('mousemove', drawSend)
board.canvas.addEventListener('mouseup', endDrawSend)
board.canvas.addEventListener('click', changeTextarea)
clearBtn.addEventListener('click', clearBoard)

for(var i = 0; i < colorRadios.length; i++) {
  var radio = colorRadios[i]
  radio.addEventListener('click', setCurColor)
}
colorPicker.addEventListener("change", setCurColor, false)
lineWidthInput.addEventListener('change', setCurLineWidth, false)
isTextInput.addEventListener('click', setIsText, false)
textarea.addEventListener('click', fillText, false)
</script>
</html>